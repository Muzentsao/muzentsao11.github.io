<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木人艸 | 點心餐盒自組系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; color: #333; }
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 品牌色系 */
        .bg-muzen-stone { background-color: #8b8c89; }
        .text-muzen-gold { color: #b0916a; }
        .border-muzen { border-color: #e5e0d8; }

        /* 盒型卡片設計 */
        .box-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border-width: 2px; }
        .box-card:hover { transform: translateY(-5px); border-color: #b0916a; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .box-card.selected { border-color: #b0916a; background-color: #fdfaf7; }

        /* 點心品項卡片 */
        .item-card { transition: all 0.2s; position: relative; }
        .item-card img { transition: transform 0.3s; }
        .item-card:hover img { transform: scale(1.05); }
        .item-card.selected { border: 2px solid #b0916a; }
        .item-card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; cursor: not-allowed; }

        /* 進度條 */
        .progress-dot.active { background-color: #b0916a; box-shadow: 0 0 0 4px rgba(176, 145, 106, 0.2); }
        
        /* PDF 列印樣式 (保留原始代碼優點) */
        @media print {
            .no-print { display: none !important; }
            .pdf-page { padding: 0 !important; border: none !important; box-shadow: none !important; }
            body { background: white; }
            #addon-modal { display: none !important; } /* 列印時隱藏彈窗 */
        }

        /* [Muzen Update] 新增自定義樣式 */
        .box-visual-slot { border: 2px dashed #e5e0d8; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; background: #fff; }
        .box-visual-slot img { width: 100%; height: 100%; object-fit: cover; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Business Logic & Pricing System Start --- */
        #addon-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: 1.5rem; }
        .package-card:hover { border-color: #b0916a; background: #fdfaf7; }
        
        /* --- Non-destructive Selection Logic Start --- */
        .selection-count-badge { position: absolute; top: -5px; right: -5px; background: #b0916a; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .finalized-order-item { border-left: 3px solid #b0916a; padding-left: 10px; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 0 8px 8px 0; }
        /* --- Non-destructive Selection Logic End --- */
        /* --- Business Logic & Pricing System End --- */
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 no-print">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="font-bold text-xl tracking-tighter text-muzen-stone">木人艸 <span class="text-xs font-light text-gray-400 ml-2 uppercase">Quotation System</span></div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="progress-dot active w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-1"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-2"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-3"></div>
                </div>
                <span class="text-sm font-medium text-gray-500 min-w-[70px] text-right" id="step-label">基本資訊</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-8">

        <div id="step-1" class="step-container active">
            <div class="bg-white rounded-2xl shadow-sm border border-muzen p-6 md:p-10">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">填寫訂購需求</h2>
                    <p class="text-gray-500 text-sm">請提供您的基本聯絡資訊，以便我們為您保存報價紀錄。</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">公司/單位名稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="company-name" class="w-full border-gray-200 border rounded-lg p-3 focus:ring-2 focus:ring-[#b0916a] outline-none" placeholder="例：木人艸股份有限公司">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold">統一編號 <span class="text-red-500">*</span></label>
                        <input type="text" id="tax-id" maxlength="8" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入 8 碼統編">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯絡人姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="contact-name" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入姓名">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯繫電話 <span class="text-red-500">*</span></label>
                        <input type="tel" id="contact-phone" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="例：0912345678">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">預計送餐日期 <span class="text-red-500">*</span></label>
                        <input type="date" id="delivery-date" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]">
                        <p class="text-[10px] text-gray-400 italic">※ 預訂須於 5 個工作天前完成</p>
                    </div>
                </div>

                <div class="mt-10 flex justify-end">
                    <button onclick="goToStep(2)" class="bg-[#333] text-white px-10 py-4 rounded-full font-bold hover:bg-black transition shadow-lg flex items-center gap-2">
                        下一步：選擇盒型與預算 <span>→</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="step-2" class="step-container">
            <button onclick="goToStep(1)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回修改客戶資訊
            </button>
            <div class="mb-8 text-center">
                <h2 class="text-2xl font-bold mb-2">選擇適合您的盒型</h2>
                <p class="text-gray-500 text-sm">點擊盒型即可查看對應的組合建議</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('craft-4', '牛皮四格盒', 200, 4)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CRAFT+4" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">牛皮四格盒</h3>
                    <p class="text-muzen-gold font-bold">$150 - $250</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('classic-6', '經典六格盒', 300, 6)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CLASSIC+6" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">經典六格盒</h3>
                    <p class="text-muzen-gold font-bold">$250 - $350</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('marble-drawer', '大理石抽屜盒', 450, 8)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=MARBLE" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">大理石抽屜盒</h3>
                    <p class="text-muzen-gold font-bold">$400 - $550</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('diamond', '美鑽盒', 600, 10)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=DIAMOND" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">美鑽盒</h3>
                    <p class="text-muzen-gold font-bold">$500 - $700</p>
                </div>
            </div>

            <div id="mode-selection" class="hidden animate-fade-in space-y-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 bg-white border border-muzen p-8 rounded-3xl hover:border-[#b0916a] cursor-pointer transition" onclick="setOrderMode('package')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">固定套餐 (Set Menu)</h4>
                            <span class="bg-gray-100 text-[10px] px-2 py-1 rounded uppercase">Excel 組合建議</span>
                        </div>
                        <p class="text-gray-500 text-sm mb-6">由主廚精選的經典搭配，快速完成餐會規劃。</p>
                        <button class="w-full py-3 border-2 border-stone-800 rounded-full font-bold">查看建議組合</button>
                    </div>

                    <div class="flex-1 bg-stone-800 text-white p-8 rounded-3xl hover:bg-stone-900 cursor-pointer transition" onclick="setOrderMode('diy')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">自由配 (DIY Journey)</h4>
                            <span class="bg-[#b0916a] text-[10px] px-2 py-1 rounded uppercase">Smart Zoning</span>
                        </div>
                        <p class="text-stone-400 text-sm mb-6">自行挑選喜愛的品項，打造獨一無二的餐盒。</p>
                        <button class="w-full py-3 bg-[#b0916a] rounded-full font-bold">開始自由搭配</button>
                    </div>
                </div>
            </div>

            <div id="package-list-area" class="hidden animate-fade-in mt-12">
                <h3 class="text-center font-bold text-lg mb-8 text-muzen-stone underline decoration-muzen-gold underline-offset-8">主廚建議組合清單</h3>
                <div id="package-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
            </div>
            </div>

        <div id="step-3" class="step-container">
            <button onclick="goToStep(2)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回更換盒型與模式
            </button>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-grow space-y-8">
                    <div id="diy-selector-area" class="bg-white p-6 rounded-2xl border border-muzen">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 id="zone-title" class="text-xl font-bold">Zone 1: 大體積品項</h2>
                                <p id="zone-desc" class="text-sm text-gray-400">請先選取飽足感單品</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400">剩餘格子數</span>
                                <div id="slots-count" class="text-3xl font-mono font-bold text-muzen-gold">4</div>
                            </div>
                        </div>
                        <div id="items-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>

                    <div id="visual-preview-area" class="bg-stone-100 p-8 rounded-3xl border border-dashed border-muzen">
                        <h3 class="text-center text-stone-400 text-xs font-bold tracking-widest uppercase mb-6">Muzen Box Simulation / AI 預覽</h3>
                        <div id="visual-box-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-2xl mx-auto"></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-muzen">
                        <h3 class="font-bold mb-4">物流與人力費用試算</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="font-bold text-muzen-gold mb-1">單趟交通費 (雙北地區)</p>
                                <span class="font-mono text-lg font-bold">$500</span>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="font-bold text-muzen-gold mb-1">人工爬梯費</p>
                                <select id="ladder-fee" onchange="updateUI()" class="w-full bg-transparent border-b border-gray-300 py-1 outline-none">
                                    <option value="0">無 / 電梯 (+$0)</option>
                                    <option value="300">2 樓 (+$300)</option>
                                    <option value="500">3 樓 (+$500)</option>
                                    <option value="600">4 樓以上 (+$600)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-80">
                    <div class="bg-white p-6 rounded-2xl border border-muzen sticky top-24">
                        <h3 class="font-bold border-b pb-4 mb-4 uppercase tracking-tighter">我的餐盒內容</h3>
                        
                        <div id="order-summary-area" class="mb-4">
                            <p class="text-[10px] text-gray-400 font-bold mb-2">已加入報價清單：</p>
                            <div id="finalized-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                <p class="text-xs text-gray-300 italic">尚未確認任何組合...</p>
                            </div>
                        </div>
                        <hr class="mb-4">
                        <p class="text-[10px] text-muzen-gold font-bold mb-1">當前選購口味 (暫存)：</p>
                        <div id="cart-list" class="space-y-3 mb-6 min-h-[100px]"></div>
                        
                        <button id="add-to-list-btn" onclick="finalizeCurrentOrder()" class="w-full py-2 mb-4 bg-muzen-gold text-white text-xs font-bold rounded-lg hover:opacity-90 transition shadow-sm">
                            確認此組合並加入清單
                        </button>
                        <div class="border-t pt-4 space-y-2 text-muzen-stone">
                            <div class="flex justify-between text-xs"><span>餐點品項小計</span><span id="items-subtotal">$0</span></div>
                            <div id="packaging-fee-row" class="flex justify-between text-xs text-blue-500 hidden">
                                <span>包材費 ($5 x 4格盒數)：</span><span id="packaging-fee-total">$0</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 pt-2"><span>物流交通費：</span><span>$500</span></div>
                            <div class="flex justify-between text-xs text-gray-400"><span>爬梯人力費：</span><span id="ladder-fee-display">$0</span></div>
                            <div class="flex justify-between text-xl font-bold border-t pt-2 text-red-700"><span>預計總金額</span><span id="grand-total">$0</span></div>
                        </div>
                        <div id="bulk-discount-note" class="hidden mt-4 p-3 bg-red-50 border border-red-100 rounded-lg text-[10px] text-red-600 leading-relaxed">
                            <strong>大宗優惠提醒：</strong>業務將於正式報價時提供免運或包材優惠。
                        </div>
                        <button onclick="triggerAddonModal()" class="w-full bg-stone-800 text-white py-4 rounded-xl mt-6 font-bold hover:bg-black transition shadow-lg">產生虛擬報價單</button>
                        <p class="text-[10px] text-gray-400 text-center mt-4 italic">最終價格以正式報價單為主</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="addon-modal" class="no-print">
        <div class="modal-content shadow-2xl">
            <h3 class="text-xl font-bold mb-2">附加服務與加購</h3>
            <p class="text-sm font-bold text-muzen-gold mb-4">紙袋加購選擇 (必選規格)</p>
            <div class="grid grid-cols-3 gap-3 mb-8">
                <label class="cursor-pointer"><input type="radio" name="paper-bag" value="L" class="hidden peer" checked><div class="text-center p-3 border rounded-xl peer-checked:border-muzen-gold peer-checked:bg-stone-50 transition"><span class="block text-xs font-bold">大尺寸</span></div></label>
                <label class="cursor-pointer"><input type="radio" name="paper-bag" value="M" class="hidden peer"><div class="text-center p-3 border rounded-xl peer-checked:border-muzen-gold peer-checked:bg-stone-50 transition"><span class="block text-xs font-bold">中尺寸</span></div></label>
                <label class="cursor-pointer"><input type="radio" name="paper-bag" value="S" class="hidden peer"><div class="text-center p-3 border rounded-xl peer-checked:border-muzen-gold peer-checked:bg-stone-50 transition"><span class="block text-xs font-bold">小尺寸</span></div></label>
            </div>
            <div class="flex gap-3">
                <button onclick="closeAddonModal()" class="flex-1 py-3 border border-gray-200 rounded-xl text-sm font-bold">返回修改</button>
                <button onclick="finalQuote()" class="flex-1 py-3 bg-stone-800 text-white rounded-xl text-sm font-bold">產出報價單</button>
            </div>
        </div>
    </div>

    <script>
        /* --- Business Logic: Excel Data Import Start --- */
        const products = [
            { id: 'S01', name: '法式經典鹹派', type: 'large', volume: 2, price: 65, img: 'https://via.placeholder.com/150?text=Quiche' },
            { id: 'S02', name: '德式香腸捲', type: 'large', volume: 2, price: 60, img: 'https://via.placeholder.com/150?text=Sausage+Roll' },
            { id: 'S03', name: '迷你燻雞三明治', type: 'large', volume: 2, price: 50, img: 'https://via.placeholder.com/150?text=Chicken' },
            { id: 'S04', name: '綜合花壽司', type: 'small', volume: 1, price: 20, img: 'https://via.placeholder.com/150?text=Sushi' },
            { id: 'S05', name: '全麥三明治', type: 'small', volume: 1, price: 40, img: 'https://via.placeholder.com/150?text=Wheat' },
            { id: 'D01', name: '洛神花瑪德蓮', type: 'small', volume: 1, price: 75, img: 'https://via.placeholder.com/150?text=Madeleine' },
            { id: 'D02', name: '焦糖海鹽磅蛋糕', type: 'small', volume: 1, price: 55, img: 'https://via.placeholder.com/150?text=Cake' },
            { id: 'D03', name: '小倉月燒', type: 'small', volume: 1, price: 30, img: 'https://via.placeholder.com/150?text=Moon' },
            { id: 'D04', name: '繽紛馬卡龍', type: 'small', volume: 1, price: 30, img: 'https://via.placeholder.com/150?text=Macaron' },
            { id: 'D05', name: '綜合水果', type: 'small', volume: 1, price: 50, img: 'https://via.placeholder.com/150?text=Fruit' },
            { id: 'D06', name: '千層菠菜蚌', type: 'small', volume: 1, price: 50, img: 'https://via.placeholder.com/150?text=Spinach' },
            { id: 'D07', name: '迷你烏龍茶生凍捲', type: 'small', volume: 1, price: 55, img: 'https://via.placeholder.com/150?text=Roll' }
        ];

        const packages = [
            { id: 'P01', name: '均衡型建議 (兩鹹兩甜)', box: 'craft-4', price: 200, items: ['D01', 'D02', 'S04', 'S05'], desc: '瑪德蓮+磅蛋糕+壽司+三明治' },
            { id: 'P02', name: '甜點型建議 (四甜)', box: 'craft-4', price: 200, items: ['D03', 'D01', 'D05', 'D04'], desc: '月燒+瑪德蓮+水果+馬卡龍' },
            { id: 'P03', name: '豐富型建議 (三鹹三甜)', box: 'classic-6', price: 300, items: ['S04', 'S05', 'D06', 'D04', 'D03', 'D07'], desc: '壽司+三明治+菠菜蚌+馬卡龍+月燒+生凍捲' }
        ];
        /* --- Business Logic: Excel Data Import End --- */

        /* --- Non-destructive Selection Logic Start --- */
        // 全域選購暫存陣列：儲存已確認的 [盒型+品項] 組合
        let finalizedOrders = [];
        /* --- Non-destructive Selection Logic End --- */

        let currentState = {
            step: 1, boxId: '', boxName: '', maxSlots: 0, remainingSlots: 0, mode: '', selectedItems: [], currentZone: 'large'
        };

        const initDatePicker = () => {
            const today = new Date(); today.setDate(today.getDate() + 7);
            document.getElementById('delivery-date').min = today.toISOString().split('T')[0];
        };
        initDatePicker();

        function goToStep(step) {
            if (step > currentState.step) {
                const company = document.getElementById('company-name').value.trim();
                const tax = document.getElementById('tax-id').value.trim();
                const phone = document.getElementById('contact-phone').value.trim();
                const name = document.getElementById('contact-name').value.trim();
                const date = document.getElementById('delivery-date').value;
                if (!company || !tax || !phone || !name || !date) { alert('請填寫所有必填欄位 (*)'); return; }
                if (tax.length !== 8) { alert('統編應為 8 碼數字'); return; }
            }
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            document.querySelectorAll('.progress-dot').forEach((dot, idx) => idx < step ? dot.classList.add('active') : dot.classList.remove('active'));
            document.getElementById('step-label').innerText = ["基本資訊", "選擇盒型", "搭配餐點"][step-1];
            currentState.step = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /* --- Non-destructive Selection Logic Start --- */
        // 修改後的盒型切換函式：移除破壞性警告，自動暫存當前選擇
        function selectBox(id, name, avgPrice, slots) {
            // 如果當前已有選好的品項且換盒型，則提示或自動處理
            if (currentState.selectedItems.length > 0 && currentState.boxId !== id) {
                console.log("切換盒型，保留當前暫存組合資料");
            }

            currentState.boxId = id; currentState.boxName = name;
            currentState.maxSlots = slots; 
            
            // 重新計算剩餘格子數 (根據現有 selectedItems)
            const usedSlots = currentState.selectedItems.reduce((s, i) => s + i.volume, 0);
            currentState.remainingSlots = slots - usedSlots;

            // UI 反饋
            document.querySelectorAll('.box-card').forEach(c => c.classList.remove('selected'));
            const card = Array.from(document.querySelectorAll('.box-card')).find(c => c.innerHTML.includes(name));
            if (card) card.classList.add('selected');
            
            document.getElementById('mode-selection').classList.remove('hidden');
            document.getElementById('package-list-area').classList.add('hidden');
            document.getElementById('slots-count').innerText = currentState.remainingSlots;
            
            // 重新渲染視覺模擬與品項清單
            renderVisualSlots(slots);
            if(currentState.mode === 'diy') renderItems(currentState.currentZone);
            updateUI();
            
            document.getElementById('mode-selection').scrollIntoView({ behavior: 'smooth' });
        }

        function renderVisualSlots(slots) {
            const visualBox = document.getElementById('visual-box-container');
            visualBox.innerHTML = '';
            for(let i=0; i<slots; i++) {
                const slot = document.createElement('div');
                slot.className = 'box-visual-slot';
                slot.id = `visual-slot-${i}`;
                slot.innerHTML = `<span class="text-[10px] text-stone-300 font-mono">${i+1}</span>`;
                visualBox.appendChild(slot);
            }
        }

        // 確認並將目前餐盒配置加入「報價清單」
        function finalizeCurrentOrder() {
            if (currentState.selectedItems.length === 0) {
                alert('請先挑選點心後再加入清單。'); return;
            }
            if (currentState.remainingSlots > 0) {
                if (!confirm(`餐盒尚未填滿 (還剩 ${currentState.remainingSlots} 格)，確定要加入清單嗎？`)) return;
            }

            const newOrder = {
                boxId: currentState.boxId,
                boxName: currentState.boxName,
                items: [...currentState.selectedItems],
                subtotal: currentState.selectedItems.reduce((s, i) => s + i.price, 0)
            };

            finalizedOrders.push(newOrder);
            currentState.selectedItems = []; // 加入清單後清空當前工作區
            currentState.remainingSlots = currentState.maxSlots;
            currentState.currentZone = 'large';
            
            alert(`已將一組【${newOrder.boxName}】加入清單！您可繼續挑選其他盒型。`);
            
            renderItems('large');
            updateUI();
        }

        // 輔助函式：計算特定口味在所有訂單中出現的次數
        function getItemSelectionCount(itemId) {
            let countInCurrent = currentState.selectedItems.filter(i => i.id === itemId).length;
            let countInFinalized = finalizedOrders.reduce((acc, order) => {
                return acc + order.items.filter(i => i.id === itemId).length;
            }, 0);
            return countInCurrent + countInFinalized;
        }
        /* --- Non-destructive Selection Logic End --- */

        function setOrderMode(mode) {
            currentState.mode = mode;
            if (mode === 'diy') {
                document.getElementById('diy-selector-area').classList.remove('hidden');
                renderItems('large');
                goToStep(3);
            } else {
                renderPackages();
            }
        }

        function renderPackages() {
            const grid = document.getElementById('package-grid');
            grid.innerHTML = '';
            const filtered = packages.filter(p => p.box === currentState.boxId);
            if (filtered.length === 0) {
                grid.innerHTML = '<p class="col-span-2 text-center text-gray-400 italic text-xs">此盒型暫無建議組合。</p>';
            } else {
                filtered.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "package-card bg-white border-2 border-muzen p-6 rounded-2xl cursor-pointer transition";
                    card.innerHTML = `<h4 class="font-bold text-muzen-stone mb-2">${p.name}</h4><p class="text-xs text-gray-400 mb-4">${p.desc}</p><div class="flex justify-between items-center"><span class="text-muzen-gold font-bold">$${p.price} / 盒</span><span class="text-[10px] bg-stone-100 px-2 py-1 rounded">點擊選用</span></div>`;
                    card.onclick = () => selectPackage(p);
                    grid.appendChild(card);
                });
            }
            document.getElementById('package-list-area').classList.remove('hidden');
            document.getElementById('package-list-area').scrollIntoView({ behavior: 'smooth' });
        }

        function selectPackage(pkg) {
            currentState.selectedItems = pkg.items.map(itemId => products.find(p => p.id === itemId));
            currentState.remainingSlots = currentState.maxSlots - currentState.selectedItems.reduce((s, i) => s + i.volume, 0);
            document.getElementById('diy-selector-area').classList.add('hidden');
            updateUI();
            goToStep(3);
        }

        function renderItems(zoneType) {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            products.filter(p => p.type === zoneType).forEach(p => {
                const isSelectedInCurrent = currentState.selectedItems.find(i => i.id === p.id);
                const canFit = p.volume <= currentState.remainingSlots;
                
                /* --- Non-destructive Selection Logic Start --- */
                // 視覺標記：顯示該口味已在整個報價清單中選購的總數
                const totalCount = getItemSelectionCount(p.id);
                const badgeHtml = totalCount > 0 ? `<div class="selection-count-badge">${totalCount}</div>` : '';
                /* --- Non-destructive Selection Logic End --- */

                const card = document.createElement('div');
                card.className = `item-card border p-3 rounded-xl bg-white shadow-sm cursor-pointer ${isSelectedInCurrent ? 'selected' : ''} ${!canFit && !isSelectedInCurrent ? 'disabled' : ''}`;
                card.innerHTML = `${badgeHtml}<div class="aspect-video rounded-lg overflow-hidden mb-2"><img src="${p.img}" class="w-full h-full object-cover"></div><div class="text-sm font-bold">${p.name}</div><div class="flex justify-between items-center mt-1"><span class="text-xs text-muzen-gold font-bold">$${p.price}</span><span class="text-[10px] bg-stone-100 px-1 rounded">佔 ${p.volume} 格</span></div>`;
                card.onclick = () => canFit || isSelectedInCurrent ? toggleItem(p) : null;
                grid.appendChild(card);
            });
            document.getElementById('zone-title').innerText = zoneType === 'large' ? 'Zone 1: 大體積品項' : 'Zone 2: 點綴品項';
        }

        function toggleItem(item) {
            const idx = currentState.selectedItems.findIndex(i => i.id === item.id);
            if (idx > -1) { currentState.selectedItems.splice(idx, 1); currentState.remainingSlots += item.volume; }
            else { currentState.selectedItems.push(item); currentState.remainingSlots -= item.volume; }
            if (currentState.currentZone === 'large' && currentState.remainingSlots < 2) { currentState.currentZone = 'small'; setTimeout(() => renderItems('small'), 300); }
            else if (currentState.currentZone === 'small' && currentState.selectedItems.filter(i => i.type === 'large').length === 0) { currentState.currentZone = 'large'; renderItems('large'); }
            else { renderItems(currentState.currentZone); }
            updateUI();
        }

        function updateUI() {
            document.getElementById('slots-count').innerText = currentState.remainingSlots;
            
            /* --- Non-destructive Selection Logic Start --- */
            // 更新報價清單概況 (Summary)
            const summaryList = document.getElementById('finalized-list');
            if (finalizedOrders.length === 0) {
                summaryList.innerHTML = '<p class="text-xs text-gray-300 italic">尚未確認任何組合...</p>';
            } else {
                summaryList.innerHTML = finalizedOrders.map((order, idx) => `
                    <div class="finalized-order-item shadow-sm">
                        <div class="flex justify-between font-bold text-[11px] text-muzen-stone">
                            <span>#${idx+1} ${order.boxName}</span>
                            <span class="text-muzen-gold">$${order.subtotal}</span>
                        </div>
                        <p class="text-[9px] text-gray-400 truncate">${order.items.map(i=>i.name).join(', ')}</p>
                    </div>
                `).join('');
            }
            /* --- Non-destructive Selection Logic End --- */

            const list = document.getElementById('cart-list');
            list.innerHTML = currentState.selectedItems.length === 0 ? '<p class="text-gray-300 text-sm italic">尚未選擇品項...</p>' : currentState.selectedItems.map(i => `<div class="flex justify-between items-center text-sm py-1 border-b border-stone-50"><span class="font-medium">${i.name}</span><span class="font-mono text-muzen-gold">$${i.price}</span></div>`).join('');

            /* --- Non-destructive Selection Logic Start --- */
            // 金額重構：加總 [已確認組合] + [當前暫存組合]
            const finalizedTotal = finalizedOrders.reduce((sum, o) => sum + (o.subtotal * 100), 0); // 假設單次 100 盒
            const currentSubtotal = currentState.selectedItems.reduce((s, i) => s + i.price, 0);
            const boxCount = 100; // 定義每種組合基準為 100 盒 (可視需求調整為動態)
            
            const totalItemSum = (finalizedOrders.reduce((s, o) => s + o.subtotal, 0) + currentSubtotal) * boxCount;
            
            // 包材費邏輯：判斷清單中屬於「四格盒」的數量 (僅限 finalizedOrders)
            const fourGridBoxOrders = finalizedOrders.filter(o => o.boxId === 'craft-4').length;
            const currentIsFourGrid = currentState.boxId === 'craft-4' && currentState.selectedItems.length > 0 ? 1 : 0;
            const totalFourGridBoxCount = (fourGridBoxOrders + currentIsFourGrid) * boxCount;
            
            let packFee = totalFourGridBoxCount * 5;
            document.getElementById('packaging-fee-row').className = packFee > 0 ? "flex justify-between text-xs text-blue-500" : "hidden";
            document.getElementById('packaging-fee-total').innerText = `$${packFee.toLocaleString()}`;
            
            document.getElementById('items-subtotal').innerText = `$${totalItemSum.toLocaleString()}`;
            
            const ladderFee = parseInt(document.getElementById('ladder-fee').value);
            document.getElementById('ladder-fee-display').innerText = `$${ladderFee.toLocaleString()}`;
            
            const grandTotal = totalItemSum + packFee + 500 + ladderFee;
            document.getElementById('box-price').innerText = `$${currentSubtotal}`; // 顯示當前這盒的單價
            document.getElementById('grand-total').innerText = `$${grandTotal.toLocaleString()}`;
            document.getElementById('bulk-discount-note').className = (finalizedOrders.length > 0 || currentSubtotal > 0) ? "mt-4 p-3 bg-red-50 border border-red-100 rounded-lg text-[10px] text-red-600" : "hidden";
            /* --- Non-destructive Selection Logic End --- */

            // 視覺模擬更新
            const visual = document.getElementById('visual-box-container'); 
            if (visual) {
                visual.innerHTML = '';
                for(let i=0; i<currentState.maxSlots; i++) {
                    const slot = document.createElement('div'); slot.className = 'box-visual-slot'; visual.appendChild(slot);
                }
                let sIdx = 0;
                currentState.selectedItems.forEach(item => {
                    if (visual.children[sIdx]) { visual.children[sIdx].innerHTML = `<img src="${item.img}">`; sIdx += item.volume; }
                });
            }
        }

        function triggerAddonModal() { 
            if (finalizedOrders.length === 0 && currentState.selectedItems.length === 0) return alert('請先確認至少一組組合。'); 
            document.getElementById('addon-modal').style.display = 'flex'; 
        }
        function closeAddonModal() { document.getElementById('addon-modal').style.display = 'none'; }
        function finalQuote() { closeAddonModal(); alert("虛擬報價單產出成功！(包含多重餐盒組合資訊)"); window.print(); }
    </script>
</body>
</html>
