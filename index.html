<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木人艸 | 點心餐盒自組系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; color: #333; }
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .bg-muzen-stone { background-color: #8b8c89; }
        .text-muzen-gold { color: #b0916a; }
        .border-muzen { border-color: #e5e0d8; }

        .box-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border-width: 2px; position: relative; }
        .box-card:hover { transform: translateY(-5px); border-color: #b0916a; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .box-card.selected { border-color: #b0916a; background-color: #fdfaf7; }

        .item-card { transition: all 0.2s; position: relative; }
        .item-card img { transition: transform 0.3s; }
        .item-card:hover img { transform: scale(1.05); }
        .item-card.selected { border: 2px solid #b0916a; }
        .item-card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; cursor: not-allowed; }

        .progress-dot.active { background-color: #b0916a; box-shadow: 0 0 0 4px rgba(176, 145, 106, 0.2); }
        
        @media print {
            .no-print { display: none !important; }
            .pdf-page { padding: 0 !important; border: none !important; box-shadow: none !important; }
            body { background: white; }
            #addon-modal { display: none !important; }
        }

        .box-visual-slot { border: 2px dashed #e5e0d8; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; background: #fff; }
        .box-visual-slot img { width: 100%; height: 100%; object-fit: cover; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #addon-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: 1.5rem; }
        .package-card:hover { border-color: #b0916a; background: #fdfaf7; }
        
        /* --- Non-destructive Selection Logic Start --- */
        .selection-count-badge { position: absolute; top: -5px; right: -5px; background: #b0916a; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .finalized-order-item { border-left: 3px solid #b0916a; padding-left: 10px; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 0 8px 8px 0; position: relative; }
        .remove-order-btn { position: absolute; top: 5px; right: 5px; color: #ccc; cursor: pointer; font-size: 12px; }
        .remove-order-btn:hover { color: #ff4d4f; }
        /* --- Non-destructive Selection Logic End --- */

        /* 修改開始：彈性分區提示與佈局樣式 */
        .capacity-tip { animation: slideIn 0.3s ease-out; background: #fdfaf7; border-left: 4px solid #b0916a; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        #visual-box-container { 
            position: relative;
            min-height: 400px; 
            background: radial-gradient(circle, #ffffff 0%, #f3f3f3 100%);
            border-radius: 24px;
            overflow: hidden;
        }
        .grid-cols-flex { display: grid; gap: 0.75rem; }
        .slot-large { grid-column: span 2; aspect-ratio: 2 / 1; }
        .slot-small { grid-column: span 1; aspect-ratio: 1 / 1; }
        /* 修改結束：彈性分區提示與佈局樣式 */
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 no-print">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="font-bold text-xl tracking-tighter text-muzen-stone">木人艸 <span class="text-xs font-light text-gray-400 ml-2 uppercase">Quotation System</span></div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="progress-dot active w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-1"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-2"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-3"></div>
                </div>
                <span class="text-sm font-medium text-gray-500 min-w-[70px] text-right" id="step-label">基本資訊</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-8">

        <div id="step-1" class="step-container active">
            <div class="bg-white rounded-2xl shadow-sm border border-muzen p-6 md:p-10">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">填寫訂購需求</h2>
                    <p class="text-gray-500 text-sm">請提供您的基本聯絡資訊，以便我們為您保存報價紀錄。</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">公司/單位名稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="company-name" class="w-full border-gray-200 border rounded-lg p-3 focus:ring-2 focus:ring-[#b0916a] outline-none" placeholder="例：木人艸股份有限公司">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold">統一編號 <span class="text-red-500">*</span></label>
                        <input type="text" id="tax-id" maxlength="8" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入 8 碼統編">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯絡人姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="contact-name" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入姓名">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯繫電話 <span class="text-red-500">*</span></label>
                        <input type="tel" id="contact-phone" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="例：0912345678">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">預計送餐日期 <span class="text-red-500">*</span></label>
                        <input type="date" id="delivery-date" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]">
                        <p class="text-[10px] text-gray-400 italic">※ 預訂須於 5 個工作天前完成</p>
                    </div>
                </div>

                <div class="mt-10 flex justify-end">
                    <button onclick="goToStep(2)" class="bg-[#333] text-white px-10 py-4 rounded-full font-bold hover:bg-black transition shadow-lg flex items-center gap-2">
                        下一步：選擇盒型與預算 <span>→</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="step-2" class="step-container">
            <button onclick="goToStep(1)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回修改客戶資訊
            </button>
            <div class="mb-8 text-center">
                <h2 class="text-2xl font-bold mb-2">選擇適合您的盒型</h2>
                <p class="text-gray-500 text-sm">點擊盒型即可查看對應的組合建議</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('craft-4', '牛皮四格盒', 200, 4)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CRAFT+4" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">牛皮四格盒</h3>
                    <p class="text-muzen-gold font-bold">$150 - $250</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('classic-6', '經典六格盒', 300, 6)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CLASSIC+6" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">經典六格盒</h3>
                    <p class="text-muzen-gold font-bold">$250 - $350</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('marble-drawer', '大理石抽屜盒', 450, 8)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=MARBLE" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">大理石抽屜盒</h3>
                    <p class="text-muzen-gold font-bold">$400 - $550</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('diamond', '美鑽盒', 600, 10)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=DIAMOND" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">美鑽盒</h3>
                    <p class="text-muzen-gold font-bold">$500 - $700</p>
                </div>
            </div>

            <div id="mode-selection" class="hidden animate-fade-in space-y-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 bg-white border border-muzen p-8 rounded-3xl hover:border-[#b0916a] cursor-pointer transition" onclick="setOrderMode('package')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">固定套餐 (Set Menu)</h4>
                            <span class="bg-gray-100 text-[10px] px-2 py-1 rounded uppercase">Excel 組合建議</span>
                        </div>
                        <p class="text-gray-500 text-sm mb-6">由主廚精選的經典搭配，快速完成餐會規劃。</p>
                        <button class="w-full py-3 border-2 border-stone-800 rounded-full font-bold">查看建議組合</button>
                    </div>

                    <div class="flex-1 bg-stone-800 text-white p-8 rounded-3xl hover:bg-stone-900 cursor-pointer transition" onclick="setOrderMode('diy')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">自由配 (DIY Journey)</h4>
                            <span class="bg-[#b0916a] text-[10px] px-2 py-1 rounded uppercase">Smart Zoning</span>
                        </div>
                        <p class="text-stone-400 text-sm mb-6">自行挑選喜愛的品項，打造獨一無二的餐盒。</p>
                        <button class="w-full py-3 bg-[#b0916a] rounded-full font-bold">開始自由搭配</button>
                    </div>
                </div>
            </div>

            <div id="package-list-area" class="hidden animate-fade-in mt-12">
                <h3 class="text-center font-bold text-lg mb-8 text-muzen-stone underline decoration-muzen-gold underline-offset-8">主廚建議組合清單</h3>
                <div id="package-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                </div>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <button onclick="goToStep(2)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回更換盒型與模式
            </button>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-grow space-y-8">
                    <div id="diy-selector-area" class="bg-white p-6 rounded-2xl border border-muzen">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 id="zone-title" class="text-xl font-bold">Zone 1: 大體積品項</h2>
                                <p id="zone-desc" class="text-sm text-gray-400">請挑選主食或飽足感單品</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400">剩餘容量分數</span>
                                <div id="slots-count" class="text-3xl font-mono font-bold text-muzen-gold">4</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mb-6">
                            <button onclick="renderItems('large')" id="btn-zone-large" class="px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen-gold bg-muzen-gold text-white transition">大體積 (主食)</button>
                            <button onclick="renderItems('small')" id="btn-zone-small" class="px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen text-muzen-stone hover:border-muzen-gold transition">小體積 (點心)</button>
                        </div>

                        <div id="items-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>

                    <div id="visual-preview-area" class="bg-stone-100 p-8 rounded-3xl border border-dashed border-muzen">
                        <h3 class="text-center text-stone-400 text-xs font-bold tracking-widest uppercase mb-6">Muzen Box Simulation / 3D 互動預覽</h3>
                        <div id="visual-box-container"></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-muzen">
                        <h3 class="font-bold mb-4">物流與人力費用試算</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="font-bold text-muzen-gold mb-1">單趟交通費 (雙北地區)</p>
                                <span class="font-mono text-lg font-bold">$500</span>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="font-bold text-muzen-gold mb-1">人工爬梯費</p>
                                <select id="ladder-fee" onchange="updateUI()" class="w-full bg-transparent border-b border-gray-300 py-1 outline-none">
                                    <option value="0">無 / 電梯 (+$0)</option>
                                    <option value="300">2 樓 (+$300)</option>
                                    <option value="500">3 樓 (+$500)</option>
                                    <option value="600">4 樓以上 (+$600)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-80">
                    <div class="bg-white p-6 rounded-2xl border border-muzen sticky top-24">
                        <h3 class="font-bold border-b pb-4 mb-4 uppercase tracking-tighter">我的餐盒內容</h3>
                        
                        <div id="order-summary-area" class="mb-4">
                            <p class="text-[10px] text-gray-400 font-bold mb-2 uppercase">已確認之報價單清單：</p>
                            <div id="finalized-list" class="space-y-2 max-h-40 overflow-y-auto pr-1 border-b pb-4 mb-4">
                                <p class="text-xs text-gray-300 italic">尚未確認任何組合...</p>
                            </div>
                        </div>
                        
                        <p class="text-[10px] text-muzen-gold font-bold mb-1 uppercase">當前自選組合暫存：</p>

                        <div id="cart-list" class="space-y-3 mb-6 min-h-[50px]"></div>
                        
                        <button id="add-to-list-btn" onclick="finalizeCurrentOrder()" class="w-full py-2 mb-4 bg-muzen-gold text-white text-xs font-bold rounded-lg hover:opacity-90 transition shadow-sm">
                            確認此組合並加入清單
                        </button>

                        <div class="border-t pt-4 space-y-2 text-muzen-stone">
                            <div class="flex justify-between text-xs"><span>餐點品項小計</span><span id="items-subtotal">$0</span></div>
                            <div class="flex justify-between text-[10px] text-gray-400">
                                <span>當前盒型單價：</span><span id="box-price">$0</span>
                            </div>
                            <div id="packaging-fee-row" class="flex justify-between text-xs text-blue-500 hidden">
                                <span>包材費 ($5 x 4格盒數)：</span><span id="packaging-fee-total">$0</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 pt-2"><span>物流交通費：</span><span>$500</span></div>
                            <div class="flex justify-between text-xs text-gray-400"><span>爬梯人力費：</span><span id="ladder-fee-display">$0</span></div>
                            <div class="flex justify-between text-xl font-bold border-t pt-2 text-red-700"><span>預計總金額</span><span id="grand-total">$0</span></div>
                        </div>
                        <button onclick="triggerAddonModal()" class="w-full bg-stone-800 text-white py-4 rounded-xl mt-6 font-bold hover:bg-black transition shadow-lg">產生虛擬報價單</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="addon-modal" class="no-print">
        <div class="modal-content shadow-2xl">
            <h3 class="text-xl font-bold mb-2">附加服務與加購</h3>
            <div class="flex gap-3">
                <button onclick="closeAddonModal()" class="flex-1 py-3 border border-gray-200 rounded-xl text-sm font-bold">返回修改</button>
                <button onclick="finalQuote()" class="flex-1 py-3 bg-stone-800 text-white rounded-xl text-sm font-bold">產出報價單</button>
            </div>
        </div>
    </div>

    <script>
        /* --- Business Logic --- */
        const products = [
            { id: 'S01', name: '法式經典鹹派', type: 'large', volume: 2, price: 65, color: 0xffcc00 },
            { id: 'S02', name: '德式香腸捲', type: 'large', volume: 2, price: 60, color: 0xcc6633 },
            { id: 'S03', name: '迷你燻雞三明治', type: 'large', volume: 2, price: 50, color: 0xffffcc },
            { id: 'S08', name: '迷迭香雞腿排', type: 'large', volume: 2, price: 85, color: 0x8b4513 },
            { id: 'S04', name: '綜合花壽司', type: 'small', volume: 1, price: 20, color: 0xffffff },
            { id: 'S05', name: '全麥三明治', type: 'small', volume: 1, price: 40, color: 0xd2b48c },
            { id: 'D01', name: '洛神花瑪德蓮', type: 'small', volume: 1, price: 75, color: 0xff0066 },
            { id: 'D02', name: '焦糖海鹽磅蛋糕', type: 'small', volume: 1, price: 55, color: 0xdaa520 },
            { id: 'D05', name: '綜合水果', type: 'small', volume: 1, price: 50, color: 0x33cc33 },
            { id: 'D07', name: '迷你烏龍生凍捲', type: 'small', volume: 1, price: 55, color: 0x006400 }
        ];

        const packages = [
            { id: 'P01', name: '春暖花開組合', box: 'craft-4', items: ['D01', 'S04', 'S05', 'S01'] }
        ];

        let finalizedOrders = [];
        let currentState = {
            step: 1, boxId: '', boxName: '', maxSlots: 0, remainingSlots: 0, mode: '', selectedItems: [], currentZone: 'large'
        };

        // 修復開始：5天工作天邏輯
        function initDatePicker() {
            const dateInput = document.getElementById('delivery-date');
            if (!dateInput) return;

            const calculateMinDate = (daysToAdd) => {
                let date = new Date();
                let added = 0;
                while (added < daysToAdd) {
                    date.setDate(date.getDate() + 1);
                    if (date.getDay() !== 0 && date.getDay() !== 6) { // 排除週日(0)與週六(6)
                        added++;
                    }
                }
                return date.toISOString().split('T')[0];
            };

            const minDate = calculateMinDate(5);
            dateInput.min = minDate;

            // 實時檢查手動輸入
            dateInput.addEventListener('change', (e) => {
                const selected = new Date(e.target.value);
                const min = new Date(minDate);
                
                // 檢查是否早於最小值或是週末
                if (selected < min || selected.getDay() === 0 || selected.getDay() === 6) {
                    alert('很抱歉，訂製餐盒需 5 個工作天前預訂（且週末不送餐），請選擇正確日期。');
                    e.target.value = '';
                }
            });
        }
        initDatePicker();
        // 修復結束：5天工作天邏輯

        function goToStep(step) {
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentState.step = step;
            if (step === 3) {
                init3DBox();
                renderItems('large');
            }
        }

        function selectBox(id, name, avgPrice, slots) {
            currentState.boxId = id; currentState.boxName = name;
            currentState.maxSlots = slots; currentState.remainingSlots = slots;
            document.querySelectorAll('.box-card').forEach(c => c.classList.remove('selected'));
            const selectedCard = document.querySelector(`.box-card[onclick*="'${id}'"]`);
            if (selectedCard) selectedCard.classList.add('selected');
            document.getElementById('mode-selection').classList.remove('hidden');
            updateUI();
        }

        function setOrderMode(mode) {
            currentState.mode = mode;
            goToStep(3);
        }

        // 修改開始：自由選配空間彈性轉換邏輯
        function renderItems(zoneType) {
            currentState.currentZone = zoneType;
            const grid = document.getElementById('items-grid');
            const descEl = document.getElementById('zone-desc');
            grid.innerHTML = '';
            
            // 更新按鈕樣式
            document.getElementById('btn-zone-large').className = zoneType === 'large' ? 'px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen-gold bg-muzen-gold text-white transition' : 'px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen text-muzen-stone hover:border-muzen-gold transition';
            document.getElementById('btn-zone-small').className = zoneType === 'small' ? 'px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen-gold bg-muzen-gold text-white transition' : 'px-4 py-2 rounded-full text-xs font-bold border-2 border-muzen text-muzen-stone hover:border-muzen-gold transition';

            // 偵測大體積配額剩餘 (空間轉換提示)
            const largeSelectedCount = currentState.selectedItems.filter(i => i.type === 'large').length;
            const maxPossibleLarge = Math.floor(currentState.maxSlots / 2);
            const remainingLargePotential = maxPossibleLarge - largeSelectedCount;

            if (zoneType === 'small' && remainingLargePotential > 0) {
                descEl.innerHTML = `<span class="capacity-tip px-2 py-1 rounded text-muzen-gold font-bold">★ 空間轉換：您未選滿主食，剩餘空間可多選 ${remainingLargePotential * 2} 樣點心。</span>`;
            } else {
                descEl.innerText = zoneType === 'large' ? "請挑選主食或飽足感單品" : "請選取搭配的小點心或水果";
            }

            products.filter(p => p.type === zoneType).forEach(p => {
                const canFit = currentState.remainingSlots >= p.volume;
                const card = document.createElement('div');
                card.className = `item-card border p-3 rounded-xl bg-white shadow-sm cursor-pointer ${!canFit ? 'opacity-40 pointer-events-none' : ''}`;
                card.innerHTML = `<div class="text-sm font-bold">${p.name}</div><div class="text-xs text-muzen-gold">$${p.price}</div><div class="text-[10px] text-gray-400 mt-1">體積: ${p.volume}</div>`;
                card.onclick = () => toggleItem(p);
                grid.appendChild(card);
            });
        }
        // 修改結束：自由選配空間彈性轉換邏輯

        function toggleItem(item) {
            if (currentState.remainingSlots >= item.volume) {
                currentState.selectedItems.push(item);
                currentState.remainingSlots -= item.volume;
                updateUI();
                renderItems(currentState.currentZone); // 實時更新可選狀態
            } else { alert("容量已滿！"); }
        }

        // --- 3D Scene Start ---
        let scene, camera, renderer, controls, currentBoxGroup, foodGroup;

        function init3DBox() {
            const container = document.getElementById('visual-box-container');
            if (renderer) {
                // 如果已存在，調整大小以防回退上一步後容器寬度變化
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                return; 
            }

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            camera.position.set(25, 25, 25);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directLight.position.set(10, 20, 10);
            directLight.castShadow = true;
            scene.add(directLight);

            animate();
            update3DModel();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer) renderer.render(scene, camera);
        }

        // 修復開始：預覽區域優化與佈局自動切換
        function update3DModel() {
            if (!scene) return;
            if (currentBoxGroup) scene.remove(currentBoxGroup);
            
            currentBoxGroup = new THREE.Group();
            foodGroup = new THREE.Group();
            currentBoxGroup.add(foodGroup);

            let boxSize = { w: 18, h: 6, d: 18 };
            let mat = new THREE.MeshStandardMaterial({ color: 0xc4a484, roughness: 0.8 }); 

            if (currentState.boxId === 'classic-6') {
                boxSize = { w: 25, h: 6, d: 16 };
            } else if (currentState.boxId === 'marble-drawer') {
                boxSize = { w: 16, h: 7, d: 9 };
                mat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.3 }); 
            } else if (currentState.boxId === 'diamond') {
                boxSize = { w: 22, h: 8, d: 15 };
            }

            const geometry = new THREE.BoxGeometry(boxSize.w, boxSize.h, boxSize.d);
            const boxBody = new THREE.Mesh(geometry, mat);
            boxBody.receiveShadow = true;
            currentBoxGroup.add(boxBody);

            // 判定佈局模式：全小型模式 vs 混合佈局
            const hasLarge = currentState.selectedItems.some(i => i.type === 'large');
            
            // 隔板邏輯：若為「全小件」模式，顯示更細密的隔板網格 (細分佈局)
            if (!hasLarge && currentState.selectedItems.length > 0) {
                // 全小件細分佈局
                if (currentState.boxId === 'craft-4') createDivider(boxSize.w, boxSize.h, boxSize.d, 2, 2, true);
                else if (currentState.boxId === 'classic-6') createDivider(boxSize.w, boxSize.h, boxSize.d, 3, 2, true);
            } else {
                // 預設混合佈局
                if (currentState.boxId === 'craft-4') createDivider(boxSize.w, boxSize.h, boxSize.d, 2, 2, false);
                else if (currentState.boxId === 'classic-6') createDivider(boxSize.w, boxSize.h, boxSize.d, 3, 2, false);
            }

            let slotIdx = 0;
            currentState.selectedItems.forEach(item => {
                addFood(item, slotIdx, boxSize, !hasLarge);
                slotIdx += item.volume;
            });

            scene.add(currentBoxGroup);
        }

        function createDivider(w, h, d, cols, rows, isFullSmall) {
            const divMat = new THREE.MeshStandardMaterial({ color: 0xbbbbbb, transparent: true, opacity: 0.5 });
            // 如果是全小件模式，針對某些盒型增加視覺細分感
            const visualCols = isFullSmall ? cols : cols; 
            const visualRows = isFullSmall ? rows : rows;

            for (let i = 1; i < visualCols; i++) {
                const div = new THREE.Mesh(new THREE.BoxGeometry(0.2, h * 0.8, d), divMat);
                div.position.x = -w/2 + (w/visualCols) * i;
                currentBoxGroup.add(div);
            }
            for (let j = 1; j < visualRows; j++) {
                const div = new THREE.Mesh(new THREE.BoxGeometry(w, h * 0.8, 0.2), divMat);
                div.position.z = -d/2 + (d/visualRows) * j;
                currentBoxGroup.add(div);
            }
        }

        function addFood(product, index, boxSize, isFullSmallMode) {
            const foodColor = product.color || 0xffaa00;
            // 全小件模式下，食物尺寸微調以填充空間
            const radius = isFullSmallMode ? 1.8 : (product.type === 'large' ? 2.5 : 1.5);
            const foodGeom = product.type === 'large' ? new THREE.CylinderGeometry(radius, radius, 2, 32) : new THREE.SphereGeometry(radius, 32, 32);
            const foodMat = new THREE.MeshStandardMaterial({ color: foodColor });
            const food = new THREE.Mesh(foodGeom, foodMat);
            food.castShadow = true;

            const cols = (currentState.boxId === 'classic-6') ? 3 : 2;
            const cellW = boxSize.w / cols;
            const cellD = boxSize.d / 2;
            
            // 計算吸附位置
            const ix = index % cols;
            const iz = Math.floor(index / cols);

            food.position.set(
                -boxSize.w/2 + cellW/2 + ix * cellW,
                boxSize.h/2 - 1,
                -boxSize.d/2 + cellD/2 + iz * cellD
            );

            foodGroup.add(food);
        }
        // 修復結束：預覽區域優化與佈局自動切換

        function updateUI() {
            document.getElementById('slots-count').innerText = currentState.remainingSlots;
            const subtotal = currentState.selectedItems.reduce((s,i)=>s+i.price, 0) * 100; // 假設一次訂100盒
            document.getElementById('items-subtotal').innerText = `$${subtotal.toLocaleString()}`;
            document.getElementById('grand-total').innerText = `$${(subtotal + 500).toLocaleString()}`; // 500 運費
            document.getElementById('box-price').innerText = `$${currentState.selectedItems.reduce((s,i)=>s+i.price, 0)}`;
            update3DModel(); 
        }

        function finalizeCurrentOrder() {
            if (currentState.selectedItems.length === 0) return;
            const newOrder = { boxId: currentState.boxId, boxName: currentState.boxName, items: [...currentState.selectedItems], subtotal: currentState.selectedItems.reduce((s, i) => s + i.price, 0) };
            finalizedOrders.push(newOrder);
            
            const list = document.getElementById('finalized-list');
            list.innerHTML = finalizedOrders.map((o, idx) => `
                <div class="finalized-order-item shadow-sm">
                    <div class="flex justify-between font-bold text-[11px] text-muzen-stone">
                        <span>#${idx+1} ${o.boxName}</span>
                        <span class="text-muzen-gold">$${o.subtotal}</span>
                    </div>
                </div>
            `).join('');

            currentState.selectedItems = [];
            currentState.remainingSlots = currentState.maxSlots;
            updateUI();
            renderItems('large');
            alert("已確認此組合並加入清單！");
        }

        function closeAddonModal() { document.getElementById('addon-modal').style.display = 'none'; }
        function triggerAddonModal() { document.getElementById('addon-modal').style.display = 'flex'; }
        function finalQuote() { window.print(); }
    </script>
</body>
</html>
