<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木人艸 | 點心餐盒自組系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; color: #333; }
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 品牌色系 */
        .bg-muzen-stone { background-color: #8b8c89; }
        .text-muzen-gold { color: #b0916a; }
        .border-muzen { border-color: #e5e0d8; }

        /* 盒型卡片設計 */
        .box-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border-width: 2px; }
        .box-card:hover { transform: translateY(-5px); border-color: #b0916a; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .box-card.selected { border-color: #b0916a; background-color: #fdfaf7; }

        /* 點心品項卡片 */
        .item-card { transition: all 0.2s; position: relative; }
        .item-card img { transition: transform 0.3s; }
        .item-card:hover img { transform: scale(1.05); }
        .item-card.selected { border: 2px solid #b0916a; }
        .item-card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; cursor: not-allowed; }

        /* 進度條 */
        .progress-dot.active { background-color: #b0916a; box-shadow: 0 0 0 4px rgba(176, 145, 106, 0.2); }
        
        /* PDF 列印樣式 (保留原始代碼優點) */
        @media print {
            .no-print { display: none !important; }
            .pdf-page { padding: 0 !important; border: none !important; box-shadow: none !important; }
            body { background: white; }
        }

        /* [Muzen Update] 新增自定義樣式 */
        .box-visual-slot { border: 2px dashed #e5e0d8; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; background: #fff; }
        .box-visual-slot img { width: 100%; height: 100%; object-fit: cover; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* [Muzen Update] 結束 */
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 no-print">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="font-bold text-xl tracking-tighter text-muzen-stone">木人艸 <span class="text-xs font-light text-gray-400 ml-2 uppercase">Quotation System</span></div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="progress-dot active w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-1"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-2"></div>
                    <div class="progress-dot w-3 h-3 rounded-full bg-gray-200 transition-all duration-300" id="dot-3"></div>
                </div>
                <span class="text-sm font-medium text-gray-500 min-w-[70px] text-right" id="step-label">基本資訊</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-8">

        <div id="step-1" class="step-container active">
            <div class="bg-white rounded-2xl shadow-sm border border-muzen p-6 md:p-10">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">填寫訂購需求</h2>
                    <p class="text-gray-500 text-sm">請提供您的基本聯絡資訊，以便我們為您保存報價紀錄。</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">公司/單位名稱 <span class="text-red-500">*</span></label>
                        <input type="text" id="company-name" class="w-full border-gray-200 border rounded-lg p-3 focus:ring-2 focus:ring-[#b0916a] outline-none" placeholder="例：木人艸股份有限公司">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold">統一編號 <span class="text-red-500">*</span></label>
                        <input type="text" id="tax-id" maxlength="8" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入 8 碼統編">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯絡人姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="contact-name" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="請輸入姓名">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-bold flex items-center gap-1">聯繫電話 <span class="text-red-500">*</span></label>
                        <input type="tel" id="contact-phone" class="w-full border-gray-200 border rounded-lg p-3 outline-none focus:ring-2 focus:ring-[#b0916a]" placeholder="例：0912345678">
                    </div>
                    </div>

                <div class="mt-10 flex justify-end">
                    <button onclick="goToStep(2)" class="bg-[#333] text-white px-10 py-4 rounded-full font-bold hover:bg-black transition shadow-lg flex items-center gap-2">
                        下一步：選擇盒型與預算 <span>→</span>
                    </button>
                    </div>
            </div>
        </div>

        <div id="step-2" class="step-container">
            <button onclick="goToStep(1)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回修改客戶資訊
            </button>
            <div class="mb-8 text-center">
                <h2 class="text-2xl font-bold mb-2">選擇適合您的盒型</h2>
                <p class="text-gray-500 text-sm">點擊盒型即可查看對應的組合建議</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('craft-4', '牛皮四格盒', 180, 4)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CRAFT+4" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">牛皮四格盒</h3>
                    <p class="text-muzen-gold font-bold">$150 - $200</p>
                    <p class="text-xs text-gray-400 mt-1">適合輕食下午茶</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('classic-6', '經典六格盒', 300, 6)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=CLASSIC+6" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">經典六格盒</h3>
                    <p class="text-muzen-gold font-bold">$250 - $350</p>
                    <p class="text-xs text-gray-400 mt-1">會議餐點首選</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('marble-drawer', '大理石抽屜盒', 450, 8)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=MARBLE" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">大理石抽屜盒</h3>
                    <p class="text-muzen-gold font-bold">$400 - $550</p>
                    <p class="text-xs text-gray-400 mt-1">尊爵商務活動</p>
                </div>

                <div class="box-card bg-white border border-gray-200 rounded-2xl p-4 text-center" onclick="selectBox('diamond', '美鑽盒', 600, 10)">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-4 overflow-hidden">
                        <img src="https://via.placeholder.com/300?text=DIAMOND" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold">美鑽盒</h3>
                    <p class="text-muzen-gold font-bold">$500 - $700</p>
                    <p class="text-xs text-gray-400 mt-1">極致奢華禮贈</p>
                </div>
            </div>

            <div id="mode-selection" class="hidden animate-fade-in space-y-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 bg-white border border-muzen p-8 rounded-3xl hover:border-[#b0916a] cursor-pointer transition" onclick="setOrderMode('package')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">固定套餐 (Set Menu)</h4>
                            <span class="bg-gray-100 text-[10px] px-2 py-1 rounded uppercase">Fast & Easy</span>
                        </div>
                        <p class="text-gray-500 text-sm mb-6">由主廚根據時令食材搭配最完美的鹹甜比例，適合追求效率的您。</p>
                        <button class="w-full py-3 border-2 border-stone-800 rounded-full font-bold">查看主廚推薦組合</button>
                    </div>

                    <div class="flex-1 bg-stone-800 text-white p-8 rounded-3xl hover:bg-stone-900 cursor-pointer transition" onclick="setOrderMode('diy')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-bold">自由配 (DIY Journey)</h4>
                            <span class="bg-[#b0916a] text-[10px] px-2 py-1 rounded uppercase">Smart Zoning</span>
                        </div>
                        <p class="text-stone-400 text-sm mb-6">透過智慧分區引導，自行挑選喜愛的品項，確保體積完美契合。</p>
                        <button class="w-full py-3 bg-[#b0916a] rounded-full font-bold">開始自由搭配</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <button onclick="goToStep(2)" class="mb-6 text-gray-400 hover:text-muzen-gold flex items-center gap-1 text-sm font-bold transition">
                <span>←</span> 返回更換盒型與預算
            </button>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-grow space-y-8">
                    <div class="bg-white p-6 rounded-2xl border border-muzen">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 id="zone-title" class="text-xl font-bold">Zone 1: 大體積品項</h2>
                                <p id="zone-desc" class="text-sm text-gray-400">請先選取 1-2 樣飽足感單品 (如鹹派、三明治)</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400">剩餘格子數</span>
                                <div id="slots-count" class="text-3xl font-mono font-bold text-muzen-gold">4</div>
                            </div>
                        </div>

                        <div id="items-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            </div>
                    </div>
                    
                    <div class="bg-stone-100 p-8 rounded-3xl border border-dashed border-muzen">
                        <h3 class="text-center text-stone-400 text-xs font-bold tracking-widest uppercase mb-6">Muzen Box Simulation / AI 預覽</h3>
                        <div id="visual-box-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-2xl mx-auto">
                            </div>
                    </div>
                    </div>

                <div class="w-full lg:w-80">
                    <div class="bg-white p-6 rounded-2xl border border-muzen sticky top-24">
                        <h3 class="font-bold border-b pb-4 mb-4 uppercase tracking-tighter">我的餐盒內容</h3>
                        <div id="cart-list" class="space-y-3 mb-6 min-h-[100px]">
                            <p class="text-gray-300 text-sm italic">尚未選擇品項...</p>
                        </div>
                        <div class="border-t pt-4 space-y-2">
                            <div class="flex justify-between text-sm"><span>預估單盒價</span><span id="box-price" class="font-bold">$0</span></div>
                            <div class="flex justify-between text-xs text-gray-400"><span>盒數：</span><span>100 盒</span></div>
                            <div class="flex justify-between text-xl font-bold border-t pt-2 text-red-700"><span>總計</span><span id="grand-total">$0</span></div>
                        </div>
                        <button onclick="generatePDF()" class="w-full bg-stone-800 text-white py-4 rounded-xl mt-6 font-bold hover:bg-black transition shadow-lg">
                            產出模擬報價單
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // 資料定義 (實際可連動 Excel 資料)
        // [Muzen Update] 修改品項定義，增加 volume (格子佔比) 邏輯
        const products = [
            { id: 'S01', name: '法式鹹派', type: 'large', volume: 2, price: 65, img: 'https://via.placeholder.com/150?text=Quiche' },
            { id: 'S02', name: '牛肉迷你漢堡', type: 'large', volume: 2, price: 75, img: 'https://via.placeholder.com/150?text=Burger' },
            { id: 'D01', name: '瑪德蓮', type: 'small', volume: 1, price: 45, img: 'https://via.placeholder.com/150?text=Madeleine' },
            { id: 'D02', name: '檸檬塔', type: 'small', volume: 1, price: 55, img: 'https://via.placeholder.com/150?text=LemonTart' },
            { id: 'D03', name: '馬卡龍', type: 'small', volume: 1, price: 40, img: 'https://via.placeholder.com/150?text=Macaron' },
            { id: 'D04', name: '可麗露', type: 'small', volume: 1, price: 60, img: 'https://via.placeholder.com/150?text=Canelé' }
        ];

        // 修改開始：切換邏輯
        let currentState = {
            step: 1,
            boxId: '',
            boxName: '',
            maxSlots: 0,
            remainingSlots: 0,
            mode: '',
            selectedItems: [],
            totalPrice: 0,
            currentZone: 'large' // large -> small
        };

        function goToStep(step) {
            // [Muzen Update] 強化 Step 1 的欄位必填檢查與統編格式檢查
            if (step > currentState.step) {
                if (currentState.step === 1) {
                    const company = document.getElementById('company-name').value.trim();
                    const tax = document.getElementById('tax-id').value.trim();
                    const phone = document.getElementById('contact-phone').value.trim();
                    const name = document.getElementById('contact-name').value.trim();

                    if (!company || !tax || !phone || !name) {
                        alert('為了提供正式報價單，請完整填寫必填欄位 (*)');
                        return;
                    }
                    if (tax.length !== 8 || isNaN(tax)) {
                        alert('統一編號應為 8 碼數字，請重新檢查。');
                        return;
                    }
                }
            }
            // [Muzen Update] 結束

            // 修改開始：狀態管理與動畫控制
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            // 進度條與標籤同步
            document.querySelectorAll('.progress-dot').forEach((dot, idx) => {
                if (idx < step) dot.classList.add('active');
                else dot.classList.remove('active');
            });

            const labels = ["基本資訊", "選擇盒型", "搭配餐點"];
            document.getElementById('step-label').innerText = labels[step-1];
            currentState.step = step;
            
            // 平滑滾動至頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function selectBox(id, name, avgPrice, slots) {
            // [Muzen Update] 狀態同步：若更換盒型，自動清空原先選好的 DIY 品項，防止容量邏輯衝突
            if (currentState.boxId !== '' && currentState.boxId !== id && currentState.selectedItems.length > 0) {
                if (confirm('更改盒型將會清空目前已選取的點心，確定要更改嗎？')) {
                    currentState.selectedItems = [];
                    currentState.currentZone = 'large';
                    updateUI();
                } else {
                    return; // 使用者取消更換
                }
            }

            currentState.boxId = id;
            currentState.boxName = name;
            currentState.maxSlots = slots;
            currentState.remainingSlots = slots;
            
            // UI 反饋
            document.querySelectorAll('.box-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('mode-selection').classList.remove('hidden');
            document.getElementById('slots-count').innerText = slots;
            
            // [Muzen Update] 動態生成視覺模擬格子
            const visualBox = document.getElementById('visual-box-container');
            visualBox.innerHTML = '';
            for(let i=0; i<slots; i++) {
                const slot = document.createElement('div');
                slot.className = 'box-visual-slot';
                slot.id = `visual-slot-${i}`;
                slot.innerHTML = `<span class="text-[10px] text-stone-300 font-mono">${i+1}</span>`;
                visualBox.appendChild(slot);
            }

            // 平滑滾動到模式選擇區塊
            document.getElementById('mode-selection').scrollIntoView({ behavior: 'smooth' });
        }

        function setOrderMode(mode) {
            currentState.mode = mode;
            if (mode === 'diy') {
                renderItems('large');
                goToStep(3);
            } else {
                alert('固定套餐正在為您加載主廚精選圖庫...');
                // 此處可擴充固定套餐邏輯
            }
        }

        function renderItems(zoneType) {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            
            // [Muzen Update] 智慧分區挑選機制：過濾剩餘空間不足的品項
            products.forEach(p => {
                const isSelected = currentState.selectedItems.find(i => i.id === p.id);
                // 判斷剩餘空間是否足以放入該品項
                const canFit = p.volume <= currentState.remainingSlots;
                const isTypeMatch = p.type === zoneType;
                
                // 如果是當前區域類型，則顯示；若空間不足則設為 Disabled
                if (isTypeMatch) {
                    const card = document.createElement('div');
                    card.className = `item-card border p-3 rounded-xl bg-white shadow-sm cursor-pointer ${isSelected ? 'selected' : ''} ${!canFit && !isSelected ? 'disabled' : ''}`;
                    card.innerHTML = `
                        <div class="aspect-video rounded-lg overflow-hidden mb-2">
                            <img src="${p.img}" class="w-full h-full object-cover">
                        </div>
                        <div class="text-sm font-bold">${p.name}</div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-muzen-gold font-bold">$${p.price}</span>
                            <span class="text-[10px] bg-stone-100 px-1 rounded">佔 ${p.volume} 格</span>
                        </div>
                    `;
                    card.onclick = () => canFit || isSelected ? toggleItem(p) : null;
                    grid.appendChild(card);
                }
            });

            document.getElementById('zone-title').innerText = zoneType === 'large' ? 'Zone 1: 大體積品項' : 'Zone 2: 點綴品項';
            document.getElementById('zone-desc').innerText = zoneType === 'large' ? '請先挑選主食類點心 (佔 2 格)' : '請填滿剩餘的格子空間 (佔 1 格)';
        }

        function toggleItem(item) {
            const index = currentState.selectedItems.findIndex(i => i.id === item.id);
            
            if (index > -1) {
                // 取消選取
                currentState.selectedItems.splice(index, 1);
                currentState.remainingSlots += item.volume;
            } else {
                // 加入選取
                if (currentState.remainingSlots < item.volume) {
                    alert('空間不足，請選擇較小的品項或移除已選項目。'); return;
                }
                currentState.selectedItems.push(item);
                currentState.remainingSlots -= item.volume;
            }

            // [Muzen Update] 智慧路徑引導：Zone 1 完成後自動切換 Zone 2
            if (currentState.currentZone === 'large' && currentState.remainingSlots < 2) {
                currentState.currentZone = 'small';
                setTimeout(() => renderItems('small'), 300);
            } else if (currentState.currentZone === 'small' && currentState.selectedItems.filter(i => i.type === 'large').length === 0) {
                 // 若大體積品項被清空，自動切回 Zone 1
                 currentState.currentZone = 'large';
                 renderItems('large');
            } else {
                renderItems(currentState.currentZone);
            }

            updateUI();
        }

        function updateUI() {
            document.getElementById('slots-count').innerText = currentState.remainingSlots;
            
            const cartList = document.getElementById('cart-list');
            if (currentState.selectedItems.length === 0) {
                cartList.innerHTML = '<p class="text-gray-300 text-sm italic">尚未選擇品項...</p>';
            } else {
                cartList.innerHTML = currentState.selectedItems.map(i => `
                    <div class="flex justify-between items-center text-sm animate-fade-in py-1 border-b border-stone-50">
                        <span class="font-medium">${i.name}</span>
                        <span class="font-mono text-muzen-gold">$${i.price}</span>
                    </div>
                `).join('');
            }

            // 動態金額計算
            const subtotal = currentState.selectedItems.reduce((sum, i) => sum + i.price, 0);
            document.getElementById('box-price').innerText = `$${subtotal}`;
            document.getElementById('grand-total').innerText = `$${(subtotal * 100).toLocaleString()}`;

            // 視覺模擬連動
            for(let i=0; i<currentState.maxSlots; i++) {
                const slot = document.getElementById(`visual-slot-${i}`);
                if (slot) slot.innerHTML = `<span class="text-[10px] text-stone-300 font-mono">${i+1}</span>`;
            }

            let slotIndex = 0;
            currentState.selectedItems.forEach(item => {
                const slot = document.getElementById(`visual-slot-${slotIndex}`);
                if (slot) {
                    slot.innerHTML = `<img src="${item.img}" title="${item.name}">`;
                    slotIndex += item.volume; 
                }
            });
        }

        function generatePDF() {
            if (currentState.remainingSlots > 0) {
                if (!confirm(`餐盒尚未填滿 (還剩 ${currentState.remainingSlots} 格)，確定要產出報價單嗎？`)) return;
            }
            alert('模擬報價單產出成功！資訊已同步至 Database。');
            window.print();
        }
        // 修改結束：切換邏輯
    </script>
</body>
</html>
